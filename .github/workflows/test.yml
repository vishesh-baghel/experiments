name: Test

on:
  push:
    branches: [main]
    paths:
      - 'packages/squad/**'
      - 'packages/jack-x-agent/**'
      - 'packages/sensie/**'
      - 'packages/llm-router/**'
      - 'packages/llm-router-ui/**'
      - 'packages/memory/**'
      - 'pnpm-lock.yaml'
      - 'package.json'
      - 'turbo.json'
      - 'tsconfig.json'
      - '.github/workflows/test.yml'
      - '.github/actions/setup-project/**'
  pull_request:
    branches: [main]
    paths:
      - 'packages/squad/**'
      - 'packages/jack-x-agent/**'
      - 'packages/sensie/**'
      - 'packages/llm-router/**'
      - 'packages/llm-router-ui/**'
      - 'packages/memory/**'
      - 'pnpm-lock.yaml'
      - 'package.json'
      - 'turbo.json'
      - 'tsconfig.json'
      - '.github/workflows/test.yml'
      - '.github/actions/setup-project/**'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # Detect which packages changed
  changes:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      squad: ${{ steps.filter.outputs.squad }}
      jack-x-agent: ${{ steps.filter.outputs.jack-x-agent }}
      sensie: ${{ steps.filter.outputs.sensie }}
      llm-router: ${{ steps.filter.outputs.llm-router }}
      llm-router-ui: ${{ steps.filter.outputs.llm-router-ui }}
      memory: ${{ steps.filter.outputs.memory }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Detect changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            squad:
              - 'packages/squad/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'turbo.json'
            jack-x-agent:
              - 'packages/jack-x-agent/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'turbo.json'
            sensie:
              - 'packages/sensie/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'turbo.json'
            llm-router:
              - 'packages/llm-router/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'turbo.json'
            llm-router-ui:
              - 'packages/llm-router-ui/**'
              - 'packages/llm-router/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'turbo.json'
            memory:
              - 'packages/memory/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'turbo.json'

  # Squad tests
  test-squad:
    needs: changes
    if: ${{ needs.changes.outputs.squad == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 2

      - name: Setup project
        uses: ./.github/actions/setup-project

      - name: Run Squad tests
        run: pnpm --filter squad test --run

      - name: Run Squad build
        run: pnpm --filter squad build

      - name: Run Squad lint
        run: pnpm --filter squad lint

  # Jack X Agent tests
  test-jack-x-agent:
    needs: changes
    if: ${{ needs.changes.outputs.jack-x-agent == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      DATABASE_URL_UNPOOLED: ${{ secrets.DATABASE_URL_UNPOOLED }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      NEXTAUTH_URL: http://localhost:3000
      LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
      LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
      LANGFUSE_BASE_URL: ${{ secrets.LANGFUSE_BASE_URL }}
      TWITTERAPI_IO_KEY: ${{ secrets.TWITTERAPI_IO_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 2

      - name: Setup project
        uses: ./.github/actions/setup-project

      - name: Generate Prisma Client
        working-directory: packages/jack-x-agent
        run: pnpm db:generate

      - name: Run database migrations
        working-directory: packages/jack-x-agent
        run: DATABASE_URL_UNPOOLED=$DATABASE_URL npx prisma migrate deploy

      - name: Run Jack X Agent tests
        working-directory: packages/jack-x-agent
        run: pnpm test:unit --run

      - name: Run Jack X Agent build
        working-directory: packages/jack-x-agent
        run: pnpm build

      - name: Run Jack X Agent lint
        working-directory: packages/jack-x-agent
        run: pnpm lint

  # Sensie tests
  test-sensie:
    needs: changes
    if: ${{ needs.changes.outputs.sensie == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      DATABASE_URL: ${{ secrets.SENSIE_DATABASE_URL }}
      DATABASE_URL_UNPOOLED: ${{ secrets.SENSIE_DATABASE_URL_UNPOOLED }}
      SESSION_SECRET: ${{ secrets.SENSIE_SESSION_SECRET }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
      LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
      LANGFUSE_BASE_URL: ${{ secrets.LANGFUSE_BASE_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 2

      - name: Setup project
        uses: ./.github/actions/setup-project

      - name: Generate Prisma Client
        working-directory: packages/sensie
        run: pnpm db:generate

      - name: Run database migrations
        working-directory: packages/sensie
        run: DATABASE_URL_UNPOOLED=$DATABASE_URL npx prisma migrate deploy

      - name: Run Sensie tests
        working-directory: packages/sensie
        run: pnpm test:unit --run

      - name: Run Sensie build
        working-directory: packages/sensie
        run: pnpm build

      - name: Run Sensie lint
        working-directory: packages/sensie
        run: pnpm lint

  # LLM Router tests
  test-llm-router:
    needs: changes
    if: ${{ needs.changes.outputs.llm-router == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 2

      - name: Setup project
        uses: ./.github/actions/setup-project

      - name: Run LLM Router tests
        run: pnpm --filter llm-router test --run

      - name: Run LLM Router build
        run: pnpm --filter llm-router build

      - name: Run LLM Router typecheck
        run: pnpm --filter llm-router typecheck

  # LLM Router UI checks
  test-llm-router-ui:
    needs: changes
    if: ${{ needs.changes.outputs.llm-router-ui == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 2

      - name: Setup project
        uses: ./.github/actions/setup-project

      - name: Run LLM Router UI build
        run: pnpm --filter llm-router-ui build

      - name: Run LLM Router UI lint
        run: pnpm --filter llm-router-ui lint

  # Memory tests
  test-memory:
    needs: changes
    if: ${{ needs.changes.outputs.memory == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      DATABASE_URL: ${{ secrets.MEMORY_DATABASE_URL }}
      SESSION_SECRET: ${{ secrets.MEMORY_SESSION_SECRET }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 2

      - name: Setup project
        uses: ./.github/actions/setup-project

      - name: Generate Drizzle Client
        working-directory: packages/memory
        run: pnpm db:generate

      - name: Run Memory tests
        working-directory: packages/memory
        run: pnpm test:unit --run

      - name: Run Memory build
        working-directory: packages/memory
        run: pnpm build

      - name: Run Memory lint
        working-directory: packages/memory
        run: pnpm lint

  # Aggregated status check for branch protection
  ci-status:
    if: always()
    needs:
      - changes
      - test-squad
      - test-jack-x-agent
      - test-sensie
      - test-llm-router
      - test-llm-router-ui
      - test-memory
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Check CI status
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          if [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more jobs were cancelled"
            exit 1
          fi
          echo "All jobs passed or were skipped"
